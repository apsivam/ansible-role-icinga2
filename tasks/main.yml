---

- name: "Install icinga2 on Linux"
  include_tasks: "install-{{ ansible_os_family }}.yml"
  tags:
    - install
    - update

- name: "upgrade IDO schema"
  include_tasks: "feature_ido-mysql_update.yml"
  when: track_icinga2_install is defined
        and track_icinga2_install.changed

- name: "Config Role"
  include_tasks: "config-{{icinga2_role}}.yml"

- name: include feature tasks
  include_tasks: "feature_{{ fItem.key }}.yml"
  vars: 
    icinga2_feature_name: "{{fItem.key}}"
  with_dict: "{{ feature_has_handler }}"
  loop_control:
    loop_var: fItem
  when: fItem.value and (fItem.key in icinga2_features)
  tags:
    - config
    - feature

- name: "Enable icinga2 feature"
  file:
    src: "../features-available/{{item.key}}.conf"
    dest: "/etc/icinga2/features-enabled/{{item.key}}.conf"
    owner: root
    group: root
    state: "{{'link' if ( item.key in icinga2_features ) else 'absent' }}"
  with_dict: "{{ feature_has_handler }}"
  notify: Test config before restart icinga 2
  tags:
    - config
    - feature
    - feature_switch
